# Development Dockerfile for Elixir umbrella
# Optimized for fast iteration with cached deps

FROM elixir:1.16-otp-26-slim

# Install build dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    git \
    inotify-tools \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Install hex and rebar
RUN mix local.hex --force && \
    mix local.rebar --force

# Set environment
ENV MIX_ENV=dev

# Copy mix files first for dependency caching
COPY mix.exs mix.lock* ./
COPY config config/
COPY apps/stellar_core/mix.exs apps/stellar_core/
COPY apps/stellar_data/mix.exs apps/stellar_data/
COPY apps/stellar_web/mix.exs apps/stellar_web/

# Get dependencies (cached layer)
RUN mix deps.get

# Compile elixir_make first (required by argon2_elixir)
RUN mix deps.compile elixir_make --force

# Compile dependencies (cached layer)
RUN mix deps.compile

# Copy source code
COPY . .

# Default command
CMD ["iex", "-S", "mix"]
