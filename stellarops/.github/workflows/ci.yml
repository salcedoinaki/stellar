name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  MIX_ENV: test
  ELIXIR_VERSION: "1.16"
  OTP_VERSION: "26"
  NODE_VERSION: "20"
  RUST_VERSION: "stable"
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/${{ github.repository_owner }}/stellarops

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # Backend (Elixir) - Lint, Test, Coverage
  # ============================================================================
  backend:
    name: Backend Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: stellarops_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: ${{ env.ELIXIR_VERSION }}
          otp-version: ${{ env.OTP_VERSION }}

      - name: Cache deps
        uses: actions/cache@v4
        with:
          path: |
            deps
            _build
          key: ${{ runner.os }}-mix-${{ env.ELIXIR_VERSION }}-${{ env.OTP_VERSION }}-${{ hashFiles('**/mix.lock') }}
          restore-keys: |
            ${{ runner.os }}-mix-${{ env.ELIXIR_VERSION }}-${{ env.OTP_VERSION }}-

      - name: Install dependencies
        run: mix deps.get

      - name: Check formatting
        run: mix format --check-formatted

      - name: Compile (warnings as errors)
        run: mix compile --warnings-as-errors

      - name: Run Credo (static analysis)
        run: mix credo --strict
        continue-on-error: true  # Don't fail build on Credo warnings initially

      - name: Run tests with coverage
        run: mix test --cover --export-coverage default
        env:
          DATABASE_URL: ecto://postgres:postgres@localhost:5432/stellarops_test

      - name: Generate coverage report
        run: mix test.coverage

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: elixir-coverage
          path: cover/
          retention-days: 7

      - name: Check coverage threshold
        run: |
          COVERAGE=$(grep -oP 'Coverage: \K[\d.]+' cover/excoveralls.html 2>/dev/null || echo "0")
          echo "Coverage: ${COVERAGE}%"
          if [ "$(echo "$COVERAGE < 70" | bc -l)" -eq 1 ]; then
            echo "::warning::Coverage is below 70%"
          fi
        continue-on-error: true

  # ============================================================================
  # Frontend (React/TypeScript) - Lint, Type-check, Test
  # ============================================================================
  frontend:
    name: Frontend Tests
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci || npm install

      - name: Lint
        run: npm run lint
        continue-on-error: true  # Don't fail on lint warnings initially

      - name: Type check
        run: npm run type-check || npx tsc --noEmit

      - name: Run tests
        run: npm run test -- --run --reporter=verbose || echo "No tests configured yet"

      - name: Build
        run: npm run build

  # ============================================================================
  # Rust Orbital Service - Lint, Test
  # ============================================================================
  orbital:
    name: Orbital Service Tests
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: services/orbital_service

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          version: "25.x"
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: services/orbital_service -> target

      - name: Check formatting
        run: cargo fmt --check

      - name: Lint with Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Run tests
        run: cargo test --all-features

      - name: Build release
        run: cargo build --release

  # ============================================================================
  # Build and Push Docker Images
  # ============================================================================
  build-images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [backend, frontend, orbital]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    permissions:
      contents: read
      packages: write

    strategy:
      matrix:
        include:
          - image: backend
            dockerfile: infrastructure/docker/Dockerfile.elixir.prod
            context: .
          - image: orbital
            dockerfile: infrastructure/docker/Dockerfile.rust.prod
            context: .
          - image: frontend
            dockerfile: infrastructure/docker/Dockerfile.frontend.prod
            context: .

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_PREFIX }}-${{ matrix.image }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.image }}
          cache-to: type=gha,mode=max,scope=${{ matrix.image }}
          build-args: |
            GIT_SHA=${{ github.sha }}
            BUILD_DATE=${{ github.event.head_commit.timestamp }}

      - name: Scan image for vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.IMAGE_PREFIX }}-${{ matrix.image }}:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results-${{ matrix.image }}.sarif'
          severity: 'CRITICAL,HIGH'
        continue-on-error: true

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results-${{ matrix.image }}.sarif'
        continue-on-error: true

  # ============================================================================
  # Deploy to Kubernetes (Dev Environment)
  # ============================================================================
  deploy-dev:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    needs: [build-images]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment: 
      name: dev
      url: https://stellarops-dev.example.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4

      - name: Configure kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG_DEV }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Update image tags in kustomization
        run: |
          cd k8s/overlays/dev
          # Update image tags to use the current SHA
          cat <<EOF >> kustomization.yaml

          # CI-generated image overrides
          images:
            - name: ghcr.io/stellarops/backend
              newName: ${{ env.IMAGE_PREFIX }}-backend
              newTag: ${{ github.sha }}
            - name: ghcr.io/stellarops/orbital
              newName: ${{ env.IMAGE_PREFIX }}-orbital
              newTag: ${{ github.sha }}
            - name: ghcr.io/stellarops/frontend
              newName: ${{ env.IMAGE_PREFIX }}-frontend
              newTag: ${{ github.sha }}
          EOF

      - name: Deploy with Kustomize
        run: |
          kubectl apply -k k8s/overlays/dev
          kubectl rollout status deployment/backend -n stellarops-dev --timeout=300s
          kubectl rollout status deployment/orbital -n stellarops-dev --timeout=300s
          kubectl rollout status deployment/frontend -n stellarops-dev --timeout=300s

      - name: Run database migrations
        run: |
          # Create a migration job
          kubectl apply -f - <<EOF
          apiVersion: batch/v1
          kind: Job
          metadata:
            name: migrate-${{ github.sha }}
            namespace: stellarops-dev
          spec:
            ttlSecondsAfterFinished: 300
            backoffLimit: 3
            template:
              spec:
                restartPolicy: Never
                containers:
                  - name: migrate
                    image: ${{ env.IMAGE_PREFIX }}-backend:${{ github.sha }}
                    command: ["/app/bin/migrate"]
                    envFrom:
                      - configMapRef:
                          name: backend-config
                      - secretRef:
                          name: backend-secrets
          EOF
          # Wait for migration to complete
          kubectl wait --for=condition=complete --timeout=120s job/migrate-${{ github.sha }} -n stellarops-dev

      - name: Verify deployment
        run: |
          echo "Checking pod status..."
          kubectl get pods -n stellarops-dev
          echo ""
          echo "Checking services..."
          kubectl get svc -n stellarops-dev
          echo ""
          echo "Checking ingress..."
          kubectl get ingress -n stellarops-dev
