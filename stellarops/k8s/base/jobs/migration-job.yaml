# Database Migration Job Template
# Use with: kubectl apply -f migration-job.yaml
# Or create dynamically in CI/CD pipelines
apiVersion: batch/v1
kind: Job
metadata:
  name: migrate
  labels:
    app: migration
    app.kubernetes.io/name: migration
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: stellarops
spec:
  # Automatically delete job after 10 minutes
  ttlSecondsAfterFinished: 600
  # Only retry once on failure
  backoffLimit: 1
  # Timeout after 5 minutes
  activeDeadlineSeconds: 300
  template:
    metadata:
      labels:
        app: migration
    spec:
      restartPolicy: Never
      # Run migrations before main deployment
      initContainers:
        - name: wait-for-db
          image: postgres:16-alpine
          command:
            - sh
            - -c
            - |
              until pg_isready -h postgres -p 5432 -U postgres; do
                echo "Waiting for PostgreSQL..."
                sleep 2
              done
              echo "PostgreSQL is ready!"
      containers:
        - name: migrate
          image: ghcr.io/stellarops/backend:latest
          command:
            - /app/bin/migrate
          envFrom:
            - configMapRef:
                name: backend-config
            - secretRef:
                name: backend-secrets
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "256Mi"
              cpu: "200m"
